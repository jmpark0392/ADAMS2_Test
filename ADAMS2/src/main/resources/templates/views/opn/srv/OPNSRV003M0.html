<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/layout}">
<th:block layout:fragment="content">
	<script src="js/js-tabler/demo-theme.min.js?1692870487"></script>
	<div class="page-wrapper" id="page-wrapper">
		<!-- Main Container -->
		<div class="container" id="container">
			<h2>[[${menuNm}]]</h2>
			<div class="ptag-container">
				<!-- <span><a href="#"> Home ></a></span> -->
				<span>[[${navigator}]]</span>
				<!-- Form Container -->
				<div class="form-container">
					<div class="form-box">
						<form id="filter-form" name="form" method="post" action="/WRKFIL001M0SelectList" onsubmit="return false;">
							<div class="row">
								<div class="col-auto">
									<label class="form-label">Search Year / Month</label>
									<select name="user[year]" class="form-select select-month-year p-1" id="inputYear">
										<option value="">Year</option>
										<option value="2020">2020</option>
										<option value="2021">2021</option>
										<option value="2022">2022</option>
										<option value="2023">2023</option>
										<option value="2024">2024</option>
										<option value="2025">2025</option>
										<option value="2026">2026</option>
									</select>
								</div>
								<!-- <div class="col-3"></div> -->
								<div class="col-auto">
									<label class="form-label">&nbsp;</label>
									<select name="user[month]" class="form-select select-month-year p-1" id="inputMonth">
										<option value="">Month</option>
										<option value="1">January</option>
										<option value="2">February</option>
										<option value="3">March</option>
										<option value="4">April</option>
										<option value="5">May</option>
										<option value="6">June</option>
										<option value="7">July</option>
										<option value="8">August</option>
										<option value="9">September</option>
										<option value="10">October</option>
										<option value="11">November</option>
										<option value="12">December</option>
									</select>
								</div>
								<div class="col-auto">
									<label class="form-label">Company Code / Name: </label>
									<!-- <div class="input-group"> -->
									<input id="companyCode" name="companyCode" type="text" class="form-control p-1" placeholder="insert value" />
									<!-- </div> -->
								</div>
								<div class="col-auto">
									<button type="button" class="btn btn-primary search-button p-1" id="searchButton">Search</button>
								</div>
								<div class="col text-end">
									<p style="height:27px;">&nbsp;</p>
									<button type="button" class="btn btn-lime" style="padding: 4px 10px; color: white; font-size: 13px" id="downloadExcel">Download</button>
								</div>
							</div>
							<!-- Extra space for folowing the form box-->
							<!-- <div style="padding-bottom: 1px"></div> -->
						</form>
					</div>
				</div>
			</div>
		</div>
		<!-- Page content -->
		<div class="page-body">
			<div class="container-xl">
				<div class="row row-cards">
					<div class="col-12 mb-3">
						<div class="card card-md d-flex flex-column h-100">
							<div id="divMyGridBackup">
								<table class="table" align="center"></table>
							</div>
						</div>
					</div>
				</div>
				<!-- <div class="col-12 mb-3">
					<div class="card card-md">
						<div class="container my-5">
              <div class="chartcontainer" style="height: 500px;">
							  <canvas id="mixedChart" width="300" height="150"></canvas>
              </div>  
						</div>
					</div> -->
          <div class="col-12 mb-3">
						<div class="card">
							<div class="card-header">
								<ul class="nav nav-tabs card-header-tabs" data-bs-toggle="tabs">
									<li class="nav-item">
										<a href="#tabs-profile" class="nav-link active" data-bs-toggle="tab">
										<span class="text-secondary">
											<svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-businessplan"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M16 6m-5 0a5 3 0 1 0 10 0a5 3 0 1 0 -10 0" /><path d="M11 6v4c0 1.657 2.239 3 5 3s5 -1.343 5 -3v-4" /><path d="M11 10v4c0 1.657 2.239 3 5 3s5 -1.343 5 -3v-4" /><path d="M11 14v4c0 1.657 2.239 3 5 3s5 -1.343 5 -3v-4" /><path d="M7 9h-2.5a1.5 1.5 0 0 0 0 3h1a1.5 1.5 0 0 1 0 3h-2.5" /><path d="M5 15v1m0 -8v1" /></svg>
												Usage Information
										</span>
										</a>
									</li>
									<li class="nav-item">
										<a href="#tabs-password" class="nav-link" data-bs-toggle="tab">
										<span class="text-secondary">
											<svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-server-cog"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 4m0 3a3 3 0 0 1 3 -3h12a3 3 0 0 1 3 3v2a3 3 0 0 1 -3 3h-12a3 3 0 0 1 -3 -3z" /><path d="M12 20h-6a3 3 0 0 1 -3 -3v-2a3 3 0 0 1 3 -3h10.5" /><path d="M18 18m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" /><path d="M18 14.5v1.5" /><path d="M18 20v1.5" /><path d="M21.032 16.25l-1.299 .75" /><path d="M16.27 19l-1.3 .75" /><path d="M14.97 16.25l1.3 .75" /><path d="M19.733 19l1.3 .75" /><path d="M7 8v.01" /><path d="M7 16v.01" /></svg>
												Service History
										</span>
										</a>
									</li>
								</ul>
							</div>
							<div class="card-body">
								<div class="tab-content">
									<div class="tab-pane active show" id="tabs-profile">
										<div class="container my-5">
											<div class="chartcontainer" style="height: 400px">
												<canvas id="usageChart" width="300" height="120"></canvas>
											</div>	
										</div>
									</div>
									<div class="tab-pane" id="tabs-password">
										<div class="container my-5">
											<div class="chartcontainer"  style="height: 400px">
												<canvas id="serviceHist" width="300" height="120"></canvas>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
				</div>
			</div>
		</div>
		<script src="js/utils.js"></script>
		<script>
      function getCsList(input) {
        console.log("getCsList input : " + input);
        var option = {
          type: "POST",
          url: "/OPNSRV003M0getGridData",
          async: false,
          dataType: "json",
          contentType: "application/json; charset=utf-8",
          data: input
        };

        gf_Transaction(option, fn_callback);
      }
    </script>
		<script>
      $(document).ready(function () {
        console.log("Document is ready.");
        //화면 접속시 바로 조회
        //getGridData();
        //send버튼 누르면, 조건적용하여 검색
        $("#send").click(getGridData);
        //엔터키누르면, 조건적용하여 검색
        $("input").on("keyup", function (key) {
          if (key.keyCode == 13) {
            getGridData();
          }
        });
      });

      function fn_callback(result) {
        console.log("result data: ", result.data); 
        if(result.data){
          let data = result.data;
          generateRandomId(data); // generate random id for each data object
          fn_setGrid(data); // set the grid with the data
          return data;
        }
      }

      function generateRandomId(data) {
        data.forEach((item, index) => {
          item.uniqueId = index + 1;
        });
        console.log("data after the unique id generation: ", data);
        return data;

      }

     
      // slicgrid 관련 변수
      var grid;
      var dataView;

      var columns = [
        // {
        //   id: "uniqueId",
        //   name: "ID",
        //   field: "uniqueId",
        //   visible: false, // to make the column invisible
        //   editor: Slick.Editors.Text,
        //   validator: createValidator,
        //   width: 10,
        //   headerCssClass: "slick-header-columns",
        //   cssClass: "slick-column-center",
        // },
        {
          id: "compNm",
          name: "Company Name",
          field: "compNm",
          sortable: true,
          editor: Slick.Editors.Text,
          validator: (value, args) =>
            complexValidator(value, args, [
              createValidator,
              noWhitespaceValidator,
            ]),
          width: 150,
          headerCssClass: "slick-header-columns",
          cssClass: "slick-column-left",
          formatter: cellValueFormatter,
        },
        {
          id: "srvcNm",
          name: "Service Name",
          field: "srvcNm",
          sortable: true,
          editor: Slick.Editors.Text,
          validator: (value, args) =>
            complexValidator(value, args, [
              createValidator,
              noWhitespaceValidator,
            ]),
          width: 150,
          headerCssClass: "slick-header-columns",
          cssClass: "slick-column-left",
        }, 
        {
          id: "dayCnt",
          name: "Usage Day Count",
          field: "dayCnt",
          sortable: true,
          editor: function (args) {
            return new ComboBoxEditor(args, [
              { key: "Y", value: "Y" },
              { key: "N", value: "N" },
            ]);
          },
          width: 100,
          headerCssClass: "slick-header-columns",
          cssClass: "slick-column-right",
        }, 
        {
          id: "srvcCostSum",
          name: "Service Cost Amount",
          field: "srvcCostSum",
          sortable: true,
          editor: Slick.Editors.Text,
          validator: createValidator,
          width: 120,
          headerCssClass: "slick-header-columns",
          cssClass: "slick-column-right",
          formatter: numberFormatter,
        },
        {
          id: "srvcCostTotal",
          name: "Service Cost Total",
          field: "srvcCostTotal",
          sortable: true,
          editor: Slick.Editors.Text,
          validator: createValidator,
          width: 120,
          headerCssClass: "slick-header-columns",
          cssClass: "slick-column-right",
          formatter: combinedFormatter
        },
        {
          id: "srvcCostExpTotal",
          name: "Expected Total Cost",
          field: "srvcCostExpTotal",
          sortable: true,
          formatter: combinedFormatter,
          editor: Slick.Editors.Text,
          validator: (value, args) =>
            complexValidator(value, args, [
              createValidator,
              noWhitespaceValidator,
            ]),
          width: 120,
          headerCssClass: "slick-header-columns",
          cssClass: "slick-column-right",
        }
      ];


      function numberFormatter(row, cell, value, columnDef, dataContext) {
        console.log(`Formatting value: ${value}`);

        if(value !== null && !isNaN(value)){
          // console.log("ADDING THE FORMAT: ", value);
          return value.toLocaleString("en-US", { minimumFractionDigits: 2,maximumFractionDigits: 2 });
        } else {
          return value;
        }
        console.log("ADDING THE FORMAT: ", value);
      }

      function cellValueFormatter(row, cell, value, columnDef, dataContext) {
          var dataView = grid.getData();

          if (row > 0) {
            let prevItem = dataView.getItem(row - 1);
            let field = columnDef.field;
            console.log("total cost data column: ", prevItem.srvcCostTotal);

            if(prevItem && prevItem[field] === dataContext[field]){
              return "";
          }
        }
        return value;
      }

      function combinedFormatter(row, cell, value, columnDef, dataContext) {
          value = cellValueFormatter(row, cell, value, columnDef, dataContext);
          if (value !== "") {
            value = numberFormatter(row, cell, value, columnDef, dataContext);
          }
          return value;
      }


      function applyCellStyleToEmpty() {
        var data = dataView.getItems();
        var cellCssStyles = {};

        for (var i = 0; i < data.length; i++) {
          if (i > 0) {
            // Check if the current row's values are the same as the previous row's values
            var isCompNmSame = data[i].compNm === data[i - 1].compNm;
            var isSrvcCostTotalSame = data[i].srvcCostTotal === data[i - 1].srvcCostTotal;
            var isSrvcCostExpTotalSame = data[i].srvcCostExpTotal === data[i - 1].srvcCostExpTotal;

            let rowId = dataView.getIdxById(data[i].id);

            if (!cellCssStyles[rowId]) {
              cellCssStyles[rowId] = {};
            }

            if (isCompNmSame) {
              cellCssStyles[rowId]["compNm"] = "no-top-border";
            }

            if (isSrvcCostTotalSame) {
              cellCssStyles[rowId]["srvcCostTotal"] = "no-top-border";
            }

            if (isSrvcCostExpTotalSame) {
              cellCssStyles[rowId]["srvcCostExpTotal"] = "no-top-border";
            }
          }
        }

        grid.setCellCssStyles("companyNameCellStyles", cellCssStyles);
      }

      var options = {
        enableCellNavigation: true,
        enableColumnReorder: false,
        forceFitColumns: true,
        multiColumnSort: true,
        numberedMultiColumnSort: true,
        tristateMultiColumnSort: true,
        sortColNumberInSeparateSpan: true,
        enableAutoSizeColumns: true,
        editable: false, // grid도 편집가능.. grid 편집 기능 제거 필요..
        enableAddRow: true,
        asyncEditorLoading: false,
        autoEdit: false,
        autoEditNewRow: false,
        rowHeight: 35,
      };

      var newRowIds = 0;

      var pluginOptions = {
        clipboardCommandHandler: function (editCommand) {
          undoRedoBuffer.queueAndExecuteCommand.call(
            undoRedoBuffer,
            editCommand
          );
        },
        readOnlyMode: false,
        includeHeaderWhenCopying: false,
        newRowCreator: function (count) {
          for (var i = 0; i < count; i++) {
            var item = {
              id: "newRow_" + newRowIds++,
            };
            grid.getData().addItem(item);
          }
        },
      };

      function getGridData() {
        // 그리드 초기화 및 데이터 로드
        console.log("Initializing SlickGrid...");


        // these will be used to get the month and year from the user
        const month = document.getElementById("inputMonth").value;
        const year = document.getElementById("inputYear").value;
        const conpanyCode = document.getElementById("companyCode").value || "0";
        const stdYymm = year + month.padStart(2, "0");
        
        console.log("company code: ", companyCode);

        // here we make a call to get the grid data
        getCsList(
          (input = JSON.stringify({
              ymd: stdYymm,
              csNo: conpanyCode
          }))
        );
      }

      function fn_setGrid(data) {

        console.log("sucessfully fetched data : ", data);
        console.log("fn_setGrid data : ", data);

        dataView = new Slick.Data.DataView();
        grid = new Slick.Grid(
          "#divMyGridBackup",
          dataView,
          columns,
          options
        );

        // Make the grid respond to DataView change events.
        dataView.onRowCountChanged.subscribe(function (e, args) {
          grid.updateRowCount();
          grid.render();
          applyCellStyleToEmpty();
        });

        dataView.onRowsChanged.subscribe(function (e, args) {
          grid.invalidate();
          grid.render();
          applyCellStyleToEmpty();
        });

        // setItems의 두번째 argument를 통해 unique id에 해당하는 컬럼 지정가능
        dataView.setItems(data, "uniqueId");

        // 정렬 sorting
        grid.onSort.subscribe(function (e, args) {
          var cols = args.sortCols;

          data.sort(function (dataRow1, dataRow2) {
            for (var i = 0, l = cols.length; i < l; i++) {
              var field = cols[i].sortCol.field;
              var sign = cols[i].sortAsc ? 1 : -1;
              var value1 = dataRow1[field],
                value2 = dataRow2[field];
              var result =
                (value1 == value2 ? 0 : value1 > value2 ? 1 : -1) * sign;
              if (result != 0) {
                return result;
              }
            }
            return 0;
          });

          grid.invalidateAllRows();
          dataView.setItems(data, "uniqueId");
          grid.render();
        });

        grid.setSelectionModel(new Slick.CellSelectionModel());
        grid.registerPlugin(new Slick.AutoTooltips());

        // set keyboard focus on the grid
        //grid.getCanvasNode().focus();
        grid.registerPlugin(
          new Slick.CellExternalCopyManager(pluginOptions)
        );

        grid.onAddNewRow.subscribe(function (e, args) {
          var newItem = args.item;
          var column = args.column;
          dataView.beginUpdate();
          dataView.setItems(data);
          dataView.endUpdate();
          grid.updateRowCount();
          grid.render();
        });

        grid.onBeforeEditCell.subscribe(function (e, args) {
          console.log("onBeforeEditCell");
        });

        grid.onCellChange.subscribe(function (e, args) {
          dataView.beginUpdate();
          dataView.setItems(data);
          dataView.endUpdate();
          grid.updateRowCount();
          grid.render();
        });

        grid.onValidationError.subscribe(function (e, args) {
          // handle validation errors originating from the CompositeEditor
          if (args.validationResults) {
            let errorMsg = args.validationResults.msg || "";
            if (
              args.editor &&
              args.editor instanceof Slick.CompositeEditor
            ) {
              if (args.validationResults.errors) {
                errorMsg += "\n";
                args.validationResults.errors.forEach(function (
                  error,
                  errorIndex
                ) {
                  const columnName = error.editor.args.column.id;
                  errorMsg += `${columnName.toUpperCase()}: ${error.msg}`;
                });
              }
              console.log(errorMsg);
            }
          } else {
            alert(errorMessages);
          }
        });

        grid.setActiveCell(0, 0);
        console.log("SlickGrid initialized.");
      }

      let usageChart;
      let serviceChart;
      //  we have to wait for the DOM to load
      document.addEventListener("DOMContentLoaded", function () {
        // making a chart using chrt.js library will start here
        const ctx = document.getElementById("usageChart").getContext("2d");
        const ctx2 = document.getElementById("serviceHist").getContext("2d");

        // const mixedChart = new Chart(ctx, config);
        usageChart = new Chart(ctx, {
          data: {
            labels: [],
            datasets: [],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: "index",
              intersect: false,
            },
            stacked: false,
            plugins: {
              title: {
                display: true,
                text: "Usage and Price Comparison",
                font: {
                  size: 18,
                  textAlign: "flex-start",
                },
              },
              tooltip: {
                enabled: true,
                mode: "index",
                intersect: false,
              },
              legend: {
                position: "top",
              },
            },
            scales: {
              // Primary y-axis for Sales (Bar Charts)
              y: {
                type: "linear",
                display: true,
                position: "left",
                title: {
                  display: true,
                  text: "User Count:",
                  font: {
                    size: 12,
                  },
                  color: "rgba(23, 162, 184, 1)",
                  // align: "start", // we align the title to the start of the axis
                },
                ticks: {
                  beginAtZero: true,
                  min: 0,
                  max: 150,
                },
                grid: {display: true},
              },
              // Secondary y-axis for Prices (Line Charts)
              y1: {
                  type: "linear",
                  display: true,
                  position: "right",
                  grid: {
                    drawOnChartArea: false, // Only want the grid lines for one axis
                  },
                  title: {
                    display: true,
                    text: "Price ($)",
                    font: {
                      size: 14,
                    },
                  },
                  ticks: {
                    beginAtZero: false,
                  },
              },
              y2: {
		              type: "linear",
		              display: false,
		              position: "right",
		              title: {
		                display: true,
		                text: "RUN TIME (Second)",
		                font: {
		                  size: 12,
		                },
		                color: "rgba(247, 103, 7, 1)",
		                // align: "start", // we align the title to the start of the axis
		              },
		              ticks: {
		                beginAtZero: false,
		                color: "rgba(247, 103, 7, 1)",
		              },
		              grid: {display: false},
		          },
            },
          },
        });

        serviceChart = new Chart(ctx2, {
          data: {
            labels: [],
            datasets: [],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: "index",
              intersect: false,
            },
            stacked: false,
            plugins: {
              title: {
                display: true,
                text: "Service History",
                font: {
                  size: 18,
                  textAlign: "flex-start",
                },
              },
              tooltip: {
                enabled: true,
                mode: "index",
                intersect: false,
              },
              legend: {
                position: "top",
              },
            },
            scales: {
              // Primary y-axis for Sales (Bar Charts)
              y: {
                type: "linear",
                display: true,
                position: "right",
                title: {
                  display: true,
                  text: "Service Count Scale: ",
                  font: {
                    size: 14,
                  },
                  // align: "start", // we align the title to the start of the axis
                },
                ticks: {
                  beginAtZero: true,
                  min: 0,
                  max: 150,
                },
              },
            },
          },
        });

        // Function to update the chart with new data
        function updateChart(data) {
          // Extract the month label from the ymd data;
          const labels = data.map((item) => item.ymd);

          // column chart data
          const basicServiceCnt = data.map((item) => item.basicCnt || 0);
          const premiumServiceCnt = data.map((item) => item.premiumCnt || 0);

          const userAvgData = data.map((item) => item.userAvg || null);

          // line chart data
          const totalCost = data.map((item) => item.srvcCostSum || null);

	        const fileSize = data.map((item) => item.fileSize || null);
	        
	        const jobTime = data.map((item) => item.jobTime || null);

          // Method to filter total cost from the first date of the month until today
          const filterTotalCostUntilToday = (data) => {
            const today = new Date();
            const firstDateOfMonth = new Date(
              today.getFullYear(),
              today.getMonth(),
              1
            );

            return data
              .filter((item) => {
                const itemDate = new Date(item.ymd);
                return itemDate >= firstDateOfMonth && itemDate <= today;
              })
              .map((item) => item.srvcCost);
          };

          const filteredTotalCost = filterTotalCostUntilToday(data);

          const expectedCost = data.map(
            (item) => item.srvcCostExpSum || null
          );

          // Update the chart data
          usageChart.data.labels = labels;
          serviceChart.data.labels = labels;
          usageChart.data.datasets = [
          {
	            type: "bar",
	            label: "Storage",
	            data: fileSize,
	            backgroundColor: "rgba(47, 179, 68, 0.3)",
	            borderColor: "rgba(47, 179, 68, 1)",
	            yAxisID: "y1",
	            borderWidth: 1,
	            barThickness: "flex",
	            barPercentage: 0.8,
	            maxBarThickness: 50,
	            order: 2,
	          },
	          {
	            type: "bar",
	            label: "Run Time",
	            data: jobTime,
	            backgroundColor: "rgba(247, 103, 7, 0.3)",
	            borderColor: "rgba(247, 103, 7, 1)",
	            yAxisID: "y2",
	            borderWidth: 1,
	            barThickness: "flex",
	            barPercentage: 0.8,
	            maxBarThickness: 50,
	            order: 3,
	          },
            {
              type: "line",
              label: "Total Cost",
              data: totalCost,
              fill: false,
              borderColor: "rgba(75, 192, 192, 1)",
              yAxisID: "y1",
              orderWidth: 2,
              spanGaps: true,
            },
            {
              type: "line",
              label: "Expected Cost",
              data: expectedCost,
              fill: false,
              borderColor: "rgba(255, 206, 86, 1)",
              yAxisID: "y1",
              orderWidth: 2,
              spanGaps: true,
            },
            {
              type: "line",
              label: "Average User Count:",
              data: userAvgData,
              fill: false,
              borderColor: "rgba(153, 102, 255, 1)",
              yAxisID: "y2",
              orderWidth: 2,
              spanGaps: true,
            }
          ];
          serviceChart.data.datasets = [
            {
                type: "bar",
                label: "Basic Service Count",
                data: basicServiceCnt,
                backgroundColor: "rgba(54, 162, 235, 0.2)",
                borderColor: "rgba(54, 162, 235, 1)",
                yAxisID: "y",
                borderWidth: 1,
                barThickness: "flex",
                maxBarThickness: 50,
            },
            {
                type: "bar",
                label: "Premium Service Count",
                data: premiumServiceCnt,
                backgroundColor: "rgba(255, 99, 132, 0.2)",
                borderColor: "rgba(255, 99, 132, 1)",
                yAxisID: "y",
                borderWidth: 1,
                barThickness: "flex",
                maxBarThickness: 50,
            }
          ];

          // Update the chart
          usageChart.update();
          serviceChart.update();
        }

        function inputValidation(input) {
          // we remove the non-digit characters 
          const numbersOnly = input.replace(/\D/g, "");

          // we check if the result stirng is exactly three digits 
          if (/^\d{3}$/.test(numbersOnly)) {
            numbersOnly
            return true;
          } else if(input === "0") {
            return true;
          } else {
            alert("Please enter a valid company code!");
            return false;
          }
        }

        // search function to make a fetch call to the server
        async function searchFunction() {
          // we check if the user has selected a month and year
          if (
            $("#inputMonth").val() === "" &&
            $("#inputYear").val() === ""
          ) {
            alert("Please select a month, year !");
            return false;
          } else if ($("#inputYear").val() === "") {
            alert("Please select a year to continue!");
            return false;
          } else if ($("#inputMonth").val() === "") {
            alert("Please select a month to continue!");
            return false;
          }

          // these will be used to get the month and year from the user
          const month = document.getElementById("inputMonth").value;
          const year = document.getElementById("inputYear").value;
          const conpanyCode = document.getElementById("companyCode").value || "0";
          const stdYymm = year + month.padStart(2, "0");

          console.log("we came here to search for the data: ", stdYymm, conpanyCode); 
          // validaion methoid will be tirggered
          inputValidation(conpanyCode)

          // when the user clicks on the serach button, we update the gfrid data by making a call.
          getGridData();

          await showSpinner();

          try {
              // Send an AJAX GET request to the endpoint
              $.ajax({
                type: "POST",
                url: "/OPNSRV003M0getChartInfos",
                data: JSON.stringify({
                  ymd: stdYymm,
                  csNo: conpanyCode

                }),
                contentType: "application/json; charset=utf-8",
                async: true,
                dataType: "json",
                success: function (data) {
                  console.log("Data received from the single ajax form:", data);
                  // we exclude the userAvg value thay are 0:
                  const filteredData = data.map(function (item) {
                      if (item.userAvg === 0) {
                          delete item.userAvg;
                      }
                      return item;
                  });

                  updateChart(filteredData);
                },
                error: function (xhr, status, error) {
                  console.error("Error fetching data:", status, error);
                },
              });
          } catch (error) {
            console.error("Error fetching data:", error);
          } finally {
            await hideSpinner();
          }
        }

        // seafch button event listener
        const searchButton = document.getElementById("searchButton");

        // here i should add the laoding animation;
        searchButton.addEventListener("click", searchFunction);

        $(document).ready(function () {
        	
          $("#inputYear").val(gv_year);
		      $("#inputMonth").val(gv_month);
          
          // in the first load, we trigger the search function
          searchFunction();
          
        });
      });

      // Download Excel functionality
      document
        .getElementById("downloadExcel")
        .addEventListener("click", function () {
          const currDate = getCurrentDateTime();
          const fileName = "WRKFIL001_FM_" + currDate; // 원하는 파일 이름으로 변경 가능
          const sheetName = "파일관리"; // 시트 이름
          const gridColumns = columns; // SlickGrid의 컬럼 배열
          const gridData = dataView.getItems(); // SlickGrid의 데이터 배열
          exportToExcel(fileName, sheetName, gridColumns, gridData);
        });
    </script>
	</div>
	<script src="js/utils.js"></script>
</th:block>
</html>